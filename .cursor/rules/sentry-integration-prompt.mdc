---
alwaysApply: false
description: Step-by-step prompt to configure Sentry in a Next.js + Cloudflare Workers project
---

# Sentry Integration Prompt for Next.js + Cloudflare Workers

Use this prompt to configure Sentry with multi-environment support (dev/production branches).

## Prerequisites

Before starting, ensure you have:
1. A Sentry account and project created
2. Your Sentry DSN (from Project Settings > Client Keys)
3. Your Sentry org and project slugs

## Step 1: Install Sentry

```bash
pnpm add @sentry/nextjs
```

## Step 2: Create Server Configuration

Create `sentry.server.config.ts` in the project root:

```typescript
import * as Sentry from "@sentry/nextjs";

const dsn = process.env.NEXT_PUBLIC_SENTRY_DSN;
const environment =
  process.env.NEXT_PUBLIC_ENVIRONMENT || process.env.NODE_ENV || "development";
const isDevelopment = environment === "development";

Sentry.init({
  dsn,
  environment,
  tracesSampleRate: isDevelopment ? 1.0 : 0.2,
  enableLogs: true,
  sendDefaultPii: true,
});
```

## Step 3: Create Edge Configuration

Create `sentry.edge.config.ts` in the project root:

```typescript
import * as Sentry from "@sentry/nextjs";

const dsn = process.env.NEXT_PUBLIC_SENTRY_DSN;
const environment =
  process.env.NEXT_PUBLIC_ENVIRONMENT || process.env.NODE_ENV || "development";
const isDevelopment = environment === "development";

Sentry.init({
  dsn,
  environment,
  tracesSampleRate: isDevelopment ? 1.0 : 0.2,
  enableLogs: true,
  sendDefaultPii: true,
});
```

## Step 4: Create Client Configuration

Create `src/instrumentation-client.ts`:

```typescript
import * as Sentry from "@sentry/nextjs";

const dsn = process.env.NEXT_PUBLIC_SENTRY_DSN;
const environment =
  process.env.NEXT_PUBLIC_ENVIRONMENT || process.env.NODE_ENV || "development";
const isDevelopment = environment === "development";

Sentry.init({
  dsn,
  environment,
  integrations: [Sentry.replayIntegration()],
  tracesSampleRate: isDevelopment ? 1.0 : 0.2,
  enableLogs: true,
  replaysSessionSampleRate: isDevelopment ? 1.0 : 0.1,
  replaysOnErrorSampleRate: 1.0,
  sendDefaultPii: true,
});

export const onRouterTransitionStart = Sentry.captureRouterTransitionStart;
```

## Step 5: Create Server Instrumentation

Create `src/instrumentation.ts`:

```typescript
import * as Sentry from "@sentry/nextjs";

export async function register() {
  if (process.env.NEXT_RUNTIME === "nodejs") {
    await import("../sentry.server.config");
  }

  if (process.env.NEXT_RUNTIME === "edge") {
    await import("../sentry.edge.config");
  }
}

export const onRequestError = Sentry.captureRequestError;
```

## Step 6: Update next.config.ts

Wrap your Next.js config with Sentry:

```typescript
import { withSentryConfig } from "@sentry/nextjs";
import type { NextConfig } from "next";

const sentryEnvironment =
  process.env.NEXT_PUBLIC_ENVIRONMENT || process.env.NODE_ENV || "development";

const nextConfig: NextConfig = {
  // your existing config
};

export default withSentryConfig(nextConfig, {
  org: "YOUR_SENTRY_ORG",
  project: "YOUR_SENTRY_PROJECT",
  silent: !process.env.CI,
  widenClientFileUpload: true,
  tunnelRoute: "/monitoring",
  release: {
    name: `YOUR_PROJECT_NAME@${sentryEnvironment}`,
  },
  webpack: {
    automaticVercelMonitors: true,
    treeshake: {
      removeDebugLogging: true,
    },
  },
});
```

## Step 7: Create Global Error Handler

Create `src/app/global-error.tsx`:

```typescript
"use client";

import * as Sentry from "@sentry/nextjs";
import NextError from "next/error";
import { useEffect } from "react";

export default function GlobalError({
  error,
}: {
  error: Error & { digest?: string };
}) {
  useEffect(() => {
    Sentry.captureException(error);
  }, [error]);

  return (
    <html>
      <body>
        <NextError statusCode={0} />
      </body>
    </html>
  );
}
```

## Step 8: Exclude from Test Coverage

Add to `vitest.config.ts` coverage exclude:

```typescript
coverage: {
  exclude: [
    // ... other excludes
    "src/instrumentation*.ts",
  ],
}
```

## Step 9: Set Environment Variables

### For Cloudflare Workers

In your Cloudflare dashboard, set these variables for each worker:

**dev branch worker:**
```
NEXT_PUBLIC_SENTRY_DSN=https://your-key@o123.ingest.sentry.io/456
NEXT_PUBLIC_ENVIRONMENT=development
```

**main branch worker:**
```
NEXT_PUBLIC_SENTRY_DSN=https://your-key@o123.ingest.sentry.io/456
NEXT_PUBLIC_ENVIRONMENT=production
```

### For Local Development

Create `.env.local`:
```
NEXT_PUBLIC_SENTRY_DSN=https://your-key@o123.ingest.sentry.io/456
NEXT_PUBLIC_ENVIRONMENT=development
```

## Sample Rates Reference

| Environment | Traces | Session Replays | Error Replays |
|-------------|--------|-----------------|---------------|
| development | 100%   | 100%            | 100%          |
| production  | 20%    | 10%             | 100%          |

## Important Notes

1. **DSN is safe to expose** - It only allows sending events, not reading them
2. **Only initialize once** - Use `import * as Sentry from "@sentry/nextjs"` in other files
3. **Filter by environment** - Use Sentry dashboard to separate dev/production events
4. **Source maps** - Set `SENTRY_AUTH_TOKEN` in CI for automatic upload
